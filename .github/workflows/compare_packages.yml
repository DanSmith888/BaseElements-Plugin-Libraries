name: Compare Packages Across Platforms

on:
  workflow_dispatch:
  # Only run on manual trigger, not on push

jobs:
  compare-packages:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x86_64
            platform: ubuntu22.04-x86_64
          - os: ubuntu-22.04-arm
            arch: aarch64
            platform: ubuntu22.04-aarch64
          - os: ubuntu-24.04
            arch: x86_64
            platform: ubuntu24.04-x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
            platform: ubuntu24.04-aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            zip \
            unzip \
            wget \
            gperf \
            cmake \
            git \
            git-lfs \
            libc++-dev \
            libc++abi-dev \
            libexpat1-dev \
            lld \
            lldb \
            liblldb-dev \
            libomp5 \
            libomp-dev \
            llvm \
            llvm-dev \
            llvm-runtime \
            libllvm-ocaml-dev \
            clang \
            clangd \
            clang-format \
            clang-tidy \
            clang-tools \
            libclang-dev \
            libclang1 \
            python3-clang \
            pkg-config

      - name: Install LLVM 18
        run: |
            wget -O /tmp/llvm.sh https://apt.llvm.org/llvm.sh
            chmod +x /tmp/llvm.sh
            sudo bash /tmp/llvm.sh 18
            rm -f /tmp/llvm.sh
            echo "Checking installed LLVM 18 binaries..."
            ls -la /usr/bin/llvm-config-18 2>/dev/null && echo "llvm-config-18 found" || echo "llvm-config-18 NOT found"
            ls -la /usr/bin/clang-18 2>/dev/null && echo "clang-18 found" || echo "clang-18 NOT found"

      - name: Configure clang alternatives
        run: |
            VERSION=18
            PRIORITY=100
            # Remove existing alternatives if they exist (from base packages)
            sudo update-alternatives --remove-all clang++ 2>/dev/null || true
            sudo update-alternatives --remove-all clang 2>/dev/null || true
            sudo update-alternatives --remove-all llvm-config 2>/dev/null || true
            
            # Check if LLVM 18 binaries exist before configuring alternatives
            if [[ -f /usr/bin/llvm-config-${VERSION} ]] && [[ -f /usr/bin/clang-${VERSION} ]]; then
            echo "Configuring alternatives for LLVM ${VERSION}..."
            sudo update-alternatives \
                --install /usr/bin/llvm-config       llvm-config      /usr/bin/llvm-config-${VERSION} ${PRIORITY} \
                --slave   /usr/bin/llvm-ar           llvm-ar          /usr/bin/llvm-ar-${VERSION} \
                --slave   /usr/bin/llvm-as           llvm-as          /usr/bin/llvm-as-${VERSION} \
                --slave   /usr/bin/llvm-bcanalyzer   llvm-bcanalyzer  /usr/bin/llvm-bcanalyzer-${VERSION} \
                --slave   /usr/bin/llvm-cov          llvm-cov         /usr/bin/llvm-cov-${VERSION} \
                --slave   /usr/bin/llvm-diff         llvm-diff        /usr/bin/llvm-diff-${VERSION} \
                --slave   /usr/bin/llvm-dis          llvm-dis         /usr/bin/llvm-dis-${VERSION} \
                --slave   /usr/bin/llvm-dwarfdump    llvm-dwarfdump   /usr/bin/llvm-dwarfdump-${VERSION} \
                --slave   /usr/bin/llvm-extract      llvm-extract     /usr/bin/llvm-extract-${VERSION} \
                --slave   /usr/bin/llvm-link         llvm-link        /usr/bin/llvm-link-${VERSION} \
                --slave   /usr/bin/llvm-mc           llvm-mc          /usr/bin/llvm-mc-${VERSION} \
                --slave   /usr/bin/llvm-nm           llvm-nm          /usr/bin/llvm-nm-${VERSION} \
                --slave   /usr/bin/llvm-objdump      llvm-objdump     /usr/bin/llvm-objdump-${VERSION} \
                --slave   /usr/bin/llvm-ranlib       llvm-ranlib      /usr/bin/llvm-ranlib-${VERSION} \
                --slave   /usr/bin/llvm-readobj      llvm-readobj     /usr/bin/llvm-readobj-${VERSION} \
                --slave   /usr/bin/llvm-rtdyld       llvm-rtdyld      /usr/bin/llvm-rtdyld-${VERSION} \
                --slave   /usr/bin/llvm-size         llvm-size        /usr/bin/llvm-size-${VERSION} \
                --slave   /usr/bin/llvm-stress       llvm-stress      /usr/bin/llvm-stress-${VERSION} \
                --slave   /usr/bin/llvm-symbolizer   llvm-symbolizer  /usr/bin/llvm-symbolizer-${VERSION} \
                --slave   /usr/bin/llvm-tblgen       llvm-tblgen      /usr/bin/llvm-tblgen-${VERSION}
            sudo update-alternatives \
                --install /usr/bin/clang                 clang                 /usr/bin/clang-${VERSION} ${PRIORITY} \
                --slave   /usr/bin/clang++               clang++               /usr/bin/clang++-${VERSION}  \
                --slave   /usr/bin/asan_symbolize        asan_symbolize        /usr/bin/asan_symbolize-${VERSION} \
                --slave   /usr/bin/clang-cpp             clang-cpp             /usr/bin/clang-cpp-${VERSION} \
                --slave   /usr/bin/lldb                  lldb                  /usr/bin/lldb-${VERSION} \
                --slave   /usr/bin/lldb-server           lldb-server           /usr/bin/lldb-server-${VERSION}
            else
            echo "Warning: LLVM ${VERSION} binaries not found. Checking available versions..."
            ls -la /usr/bin/llvm-config-* 2>/dev/null || echo "No llvm-config versions found"
            ls -la /usr/bin/clang-* 2>/dev/null | head -5 || echo "No clang versions found"
            echo "Falling back to system defaults."
            fi

      - name: Debug - Show LLVM and Clang versions
        run: |
            echo "=========================================="
            echo "LLVM and Clang Version Information"
            echo "=========================================="
            echo ""
            echo "=== Clang Version ==="
            clang --version || echo "clang not found"
            echo ""
            echo "=== Clang++ Version ==="
            clang++ --version || echo "clang++ not found"
            echo ""
            echo "=== LLVM Config Version ==="
            llvm-config --version || echo "llvm-config not found"
            echo ""
            echo "=== Which binaries are being used ==="
            which clang || echo "clang not in PATH"
            which clang++ || echo "clang++ not in PATH"
            which llvm-config || echo "llvm-config not in PATH"
            echo ""
            echo "=== Real paths (resolving symlinks) ==="
            readlink -f $(which clang 2>/dev/null) || echo "clang not found"
            readlink -f $(which clang++ 2>/dev/null) || echo "clang++ not found"
            readlink -f $(which llvm-config 2>/dev/null) || echo "llvm-config not found"
            echo ""
            echo "=========================================="

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x scripts/build/*.sh 2>/dev/null || true
          chmod +x scripts/install/*.sh 2>/dev/null || true

      - name: Run package comparison script
        working-directory: scripts
        env:
          GITHUB_PLATFORM: ${{ matrix.platform }}
        run: |
          # Override hostname detection to use platform name for consistent file naming
          export HOSTNAME="github-actions-${{ matrix.platform }}"
          ./compare_packages.sh

      - name: Upload package comparison results
        uses: actions/upload-artifact@v4
        with:
          name: package-comparison-${{ matrix.platform }}
          path: scripts/package_lists/
          retention-days: 90
          if-no-files-found: warn

  create-release:
    needs: compare-packages
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all package comparison artifacts
        uses: actions/download-artifact@v4
        with:
          path: package_comparisons
          pattern: package-comparison-*

      - name: Create comparison archive
        run: |
          cd package_comparisons
          tar -czf ../package_comparison_$(date +%Y%m%d_%H%M%S).tar.gz .
          cd ..
          ls -lh package_comparison_*.tar.gz

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: package_comparison_*.tar.gz
          tag_name: package-comparison-$(date +%Y%m%d-%H%M%S)
          name: Package Comparison Results
          body: |
            Package comparison results for all Ubuntu platforms.
            
            This archive contains:
            - Package lists (.all files)
            - Full dpkg output (.dpkg_full files)
            - All pkg-config packages (.pkgconfig_all files)
            - All environment variables (.env_all files)
            
            Use scripts/compare_package_lists.sh to compare results between platforms.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

