name: Build and Release Libraries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x86_64
            platform: ubuntu22.04-x86_64
          - os: ubuntu-22.04-arm
            arch: aarch64
            platform: ubuntu22.04-aarch64
          - os: ubuntu-24.04
            arch: x86_64
            platform: ubuntu24.04-x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
            platform: ubuntu24.04-aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LLVM 18
        run: |
          wget -O - https://apt.llvm.org/llvm.sh | sudo bash -s 18
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            zip \
            unzip \
            wget \
            gperf \
            cmake \
            git \
            git-lfs \
            libc++-dev \
            libc++abi-dev \
            libexpat1-dev \
            lld \
            lldb \
            liblldb-dev \
            libomp5 \
            libomp-dev \
            llvm \
            llvm-dev \
            llvm-runtime \
            libllvm-ocaml-dev \
            clang \
            clangd \
            clang-format \
            clang-tidy \
            clang-tools \
            libclang-dev \
            libclang1 \
            python3-clang \

      - name: Debug webp and build environment
        run: |
          echo "=========================================="
          echo "DEBUG: Build Environment Diagnostics"
          echo "=========================================="
          echo ""
          echo "=== Platform Info ==="
          echo "OS: ${{ matrix.os }}"
          echo "Arch: ${{ matrix.arch }}"
          echo "Platform: ${{ matrix.platform }}"
          lsb_release -a 2>/dev/null || echo "lsb_release not available"
          echo ""
          
          echo "=== CMake Info ==="
          cmake --version || echo "cmake not found"
          which cmake || echo "cmake not in PATH"
          echo ""
          
          echo "=== pkg-config Info ==="
          which pkg-config || echo "pkg-config NOT installed"
          pkg-config --version 2>/dev/null || echo "pkg-config not available"
          echo "PKG_CONFIG_PATH: ${PKG_CONFIG_PATH:-not set}"
          echo ""
          
          echo "=== WebP Package Check ==="
          echo "Checking for webp runtime packages:"
          dpkg -l | grep -i webp || echo "No webp packages found"
          echo ""
          echo "Checking for webp-dev package:"
          dpkg -l | grep -i "webp-dev" || echo "libwebp-dev NOT installed"
          echo ""
          
          echo "=== WebP pkg-config Files ==="
          echo "Searching for webp .pc files in pkg-config directories:"
          for pc_dir in /usr/lib/pkgconfig /usr/lib/x86_64-linux-gnu/pkgconfig /usr/lib/aarch64-linux-gnu/pkgconfig /usr/share/pkgconfig /usr/local/lib/pkgconfig /usr/local/share/pkgconfig; do
            if [ -d "$pc_dir" ]; then
              found=$(find "$pc_dir" -maxdepth 1 -name "*webp*.pc" 2>/dev/null)
              if [ -n "$found" ]; then
                echo "  Found in $pc_dir:"
                echo "$found" | sed 's/^/    /'
              fi
            fi
          done | head -20 || echo "  No webp .pc files found"
          echo ""
          echo "Checking pkg-config search paths:"
          pkg-config --variable pc_path pkg-config 2>/dev/null || echo "Cannot get pkg-config paths"
          echo ""
          
          echo "=== WebP Detection Tests ==="
          if command -v pkg-config >/dev/null 2>&1; then
            echo "Testing pkg-config --exists libwebp:"
            pkg-config --exists libwebp && echo "  ✓ webp FOUND via pkg-config" || echo "  ✗ webp NOT found via pkg-config"
            echo ""
            echo "Testing pkg-config --libs libwebp:"
            pkg-config --libs libwebp 2>&1 || echo "  Cannot get webp libs"
            echo ""
            echo "Testing pkg-config --cflags libwebp:"
            pkg-config --cflags libwebp 2>&1 || echo "  Cannot get webp cflags"
            echo ""
            echo "All packages containing 'webp' in pkg-config:"
            pkg-config --list-all 2>/dev/null | grep -i webp || echo "  No webp packages in pkg-config"
          else
            echo "pkg-config not available, skipping detection tests"
          fi
          echo ""
          
          echo "=== WebP Library Files ==="
          echo "Searching for libwebp.so files:"
          for lib_dir in /usr/lib /usr/lib/x86_64-linux-gnu /usr/lib/aarch64-linux-gnu /usr/local/lib; do
            if [ -d "$lib_dir" ]; then
              found=$(find "$lib_dir" -maxdepth 2 -name "*webp*.so*" 2>/dev/null | head -5)
              if [ -n "$found" ]; then
                echo "$found"
              fi
            fi
          done | head -10 || echo "No webp .so files found"
          echo ""
          echo "Searching for libwebp.a files:"
          for lib_dir in /usr/lib /usr/lib/x86_64-linux-gnu /usr/lib/aarch64-linux-gnu /usr/local/lib; do
            if [ -d "$lib_dir" ]; then
              found=$(find "$lib_dir" -maxdepth 2 -name "*webp*.a" 2>/dev/null | head -5)
              if [ -n "$found" ]; then
                echo "$found"
              fi
            fi
          done | head -10 || echo "No webp .a files found"
          echo ""
          
          echo "=== WebP Header Files ==="
          echo "Searching for webp headers:"
          for inc_dir in /usr/include /usr/local/include; do
            if [ -d "$inc_dir" ]; then
              found=$(find "$inc_dir" -maxdepth 2 -name "*webp*" -type f 2>/dev/null | head -5)
              if [ -n "$found" ]; then
                echo "$found"
              fi
            fi
          done | head -10 || echo "No webp headers found"
          echo ""
          
          echo "=== What Depends on WebP ==="
          echo "Packages that depend on libwebp7:"
          apt-cache rdepends libwebp7 2>/dev/null | head -20 || echo "Cannot check dependencies"
          echo ""
          echo "Packages that depend on libwebp-dev:"
          apt-cache rdepends libwebp-dev 2>/dev/null | head -20 || echo "Cannot check dependencies"
          echo ""
          
          echo "=== CMake Package Detection ==="
          echo "Testing CMake find_package for WebP:"
          printf '%s\n' \
            'find_package(PkgConfig QUIET)' \
            'if(PkgConfig_FOUND)' \
            '  pkg_check_modules(WEBP QUIET libwebp)' \
            '  if(WEBP_FOUND)' \
            '    message(STATUS "CMake found webp via pkg-config")' \
            '    message(STATUS "  WEBP_LIBRARIES: ${WEBP_LIBRARIES}")' \
            '    message(STATUS "  WEBP_INCLUDE_DIRS: ${WEBP_INCLUDE_DIRS}")' \
            '  else()' \
            '    message(STATUS "CMake did NOT find webp via pkg-config")' \
            '  endif()' \
            'else()' \
            '  message(STATUS "pkg-config not available to CMake")' \
            'endif()' \
            'find_library(WEBP_LIB webp PATHS /usr/lib /usr/lib/x86_64-linux-gnu /usr/lib/aarch64-linux-gnu)' \
            'if(WEBP_LIB)' \
            '  message(STATUS "CMake found webp library: ${WEBP_LIB}")' \
            'else()' \
            '  message(STATUS "CMake did NOT find webp library")' \
            'endif()' > /tmp/test_webp.cmake
          cmake -P /tmp/test_webp.cmake || echo "CMake test failed"
          echo ""
          
          echo "=== Library Search Paths ==="
          echo "Standard library paths:"
          if [ -d /usr/lib ]; then echo "  /usr/lib: found"; else echo "  /usr/lib: not found"; fi
          if [ -d /usr/lib/x86_64-linux-gnu ]; then echo "  /usr/lib/x86_64-linux-gnu: found"; else echo "  /usr/lib/x86_64-linux-gnu: not found"; fi
          if [ -d /usr/lib/aarch64-linux-gnu ]; then echo "  /usr/lib/aarch64-linux-gnu: found"; else echo "  /usr/lib/aarch64-linux-gnu: not found"; fi
          echo ""
          
          echo "=========================================="
          echo "End of diagnostics"
          echo "=========================================="

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x scripts/build/*.sh
          chmod +x scripts/install/*.sh

      # - name: Configure clang alternatives
      #   run: |
      #     sudo scripts/install/update-alternatives-clang.sh

      - name: Clean output folder
        working-directory: scripts
        run: ./0_cleanOutputFolder.sh

      - name: Download sources
        working-directory: scripts
        run: ./1_getSource.sh

      - name: Build all libraries
        working-directory: scripts
        run: ./2_build.sh --build all

      - name: Package libraries
        working-directory: scripts
        run: ./4_package.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: external-${{ matrix.platform }}
          path: output/platforms/external-${{ matrix.platform }}.tar.gz
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

